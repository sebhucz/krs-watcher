<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KRS Watcher – Panel</title>
<style>
  :root { --bg:#0b1220; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; --ok:#22c55e; --warn:#facc15; --err:#ef4444; --border:#1f2937; }
  @media (prefers-color-scheme: light) {
    :root { --bg:#f8fafc; --card:#ffffff; --fg:#111827; --muted:#6b7280; --accent:#2563eb; --ok:#16a34a; --warn:#ca8a04; --err:#b91c1c; --border:#e5e7eb; }
  }
  * { box-sizing: border-box }
  body { margin:0; font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--fg); }
  header { padding:16px; border-bottom:1px solid var(--border); background:var(--card); position:sticky; top:0; z-index:10; }
  .wrap { max-width:1100px; margin:0 auto; padding:16px; }
  .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center }
  input[type="text"] { flex:1 1 420px; padding:12px 14px; border:1px solid var(--border); background:transparent; color:var(--fg); border-radius:12px; outline:none }
  button { padding:12px 16px; border-radius:12px; border:1px solid var(--border); background:var(--card); color:var(--fg); cursor:pointer }
  button:hover { border-color:var(--accent) }
  small { color:var(--muted) }
  .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
  .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#0b122010; margin-left:8px }
  .muted { color:var(--muted) }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <strong>KRS Watcher – Panel</strong>
    <small>• wpisz KRS i sprawdź od razu • jeśli CORS, użyj „Wklej JSON”</small>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="row">
      <input id="krs" inputmode="numeric" pattern="[0-9]*" maxlength="10" placeholder="Wpisz numer KRS (10 cyfr)" />
      <button id="btn">Sprawdź teraz</button>
      <span id="meta" class="pill">—</span>
    </div>
  </div>

  <div id="out" style="margin-top:12px"></div>
</main>

<script>
const $ = (id) => document.getElementById(id);

function normKrs(v){ return String(v||'').replace(/\D/g,'').padStart(10,'0').slice(-10); }
function apiUrl(krs){ return `https://api-krs.ms.gov.pl/api/krs/OdpisPelny/${krs}?rejestr=P&format=json`; }

// znajdź ostatni wpis
function getLastEntry(payload){
  const wpisy = payload?.odpis?.naglowekP?.wpis || [];
  if(!Array.isArray(wpisy) || !wpisy.length) return { numer:null, data:null };
  let best = null;
  for(const w of wpisy){
    const n = Number(w?.numerWpisu);
    if(Number.isFinite(n)){
      if(!best || n > best.numer){
        best = { numer:n, data: w?.dataDokonaniaWpisu || w?.dataWpisu || null };
      }
    }
  }
  return best || { numer:null, data:null };
}

// pobierz nazwę spółki (tylko Dział I)
function getCompanyName(payload){
  return payload?.odpis?.dane?.dzial1?.danePodmiotu?.nazwa
      || payload?.odpis?.dane?.dzialI?.danePodmiotu?.nazwa
      || "—";
}

// renderuj dane
function render(payload){
  const last = getLastEntry(payload);
  const company = getCompanyName(payload);
  const dateStr = last.data ? new Date(last.data).toLocaleDateString("pl-PL") : "brak daty";

  $("out").innerHTML = `
    <h2>KRS ${payload.odpis.naglowekP.numerKRS} — ${company}</h2>
    <p><strong>Ostatni wpis:</strong> ${last.numer ?? "—"} (${dateStr})</p>
  `;
}

// fetch z API
$("btn").onclick = async ()=>{
  const krs = normKrs($("krs").value);
  if(!/^\d{10}$/.test(krs)) { alert("Niepoprawny numer KRS"); return; }
  $("meta").textContent = apiUrl(krs);
  try {
    const res = await fetch(apiUrl(krs));
    const data = await res.json();
    render(data);
  } catch(err){
    console.error(err);
    $("out").innerHTML = `<p class="muted">Błąd pobierania danych</p>`;
  }
};
</script>
</body>
</html>
